---
# Different ways of collecting data from network devices are shown here (ansible facts and ntc-templates)
# Interfaces and IP addresses are added using gathered ansible facts
# - name: Cisco - add interfaces
#   netbox.netbox.netbox_device_interface:
#     data:
#       device: "{{ inventory_hostname }}"
#       name: "{{ item.key }}"
#       type: "Virtual"
#       description: "{{ item.value.description }}"
#       mac_address: "{{ item.value.macaddress }}"
#       mtu: "{{ item.value.mtu }}"
#     state: present
#   with_dict:
#     - "{{ ansible_net_interfaces }}"
#   when: ansible_network_os == 'cisco.ios.ios'

# - name: Cisco - add IP addresses to interfaces
#   netbox.netbox.netbox_ip_address:
#     data:
#       address: "{{ item.value.ipv4 | map(attribute='address') | join() ~ '/' ~ item.value.ipv4 | map(attribute='subnet') | join() }}"
#       assigned_object:
#         name: "{{ item.key }}"
#         device: "{{ inventory_hostname }}"
#     state: present
#   with_dict:
#     - "{{ ansible_net_interfaces }}"
#   when: 
#     - ansible_network_os == 'cisco.ios.ios'
#     - item.value.ipv4 | map(attribute='address')

# - name: Arista - add interfaces
#   netbox.netbox.netbox_device_interface:
#     data:
#       device: "{{ inventory_hostname }}"
#       name: "{{ item.key }}"
#       type: "Virtual"
#       description: "{{ item.value.description }}"
#       mac_address: "{{ item.value.macaddress }}"
#       mtu: "{{ item.value.mtu }}"
#     state: present
#   with_dict:
#     - "{{ ansible_net_interfaces }}"
#   when: ansible_network_os == 'arista.eos.eos'

# - name: Arista - add IP addresses to interfaces
#   netbox.netbox.netbox_ip_address:
#     data:
#       address: "{{ item.value.ipv4.address ~ '/' ~ item.value.ipv4.masklen }}"
#       assigned_object:
#         name: "{{ item.key }}"
#         device: "{{ inventory_hostname }}"
#     state: present
#   with_dict:
#     - "{{ ansible_net_interfaces }}"
#   when: 
#     - ansible_network_os == 'arista.eos.eos'
#     - item.value.ipv4.address is defined


# Vlans are added using data gathered with ntc-templates

- name: "Run command and parse with ntc_templates"
  ansible.utils.cli_parse:
    command: show vlan
    parser:
      name: ansible.netcommon.ntc_templates
    set_fact: vlans
  when: inventory_hostname in groups['switches']

- name: Create vlan within NetBox with only required information
  netbox_vlan:
    netbox_url: http://netbox.local
    netbox_token: thisIsMyToken
    data:
      name: Test VLAN
      vid: 400
    state: present